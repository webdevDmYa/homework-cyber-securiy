# homework_vulnerability_scanner.py
# –ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π –∫—Ä–æ—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–Ω–∏–π vulnerability scanner (Windows / macOS / Linux)

import subprocess
import platform
import csv
import requests
import time
import random
from typing import Optional, List, Dict


# =========================
# –ó–ë–Ü–† –í–°–¢–ê–ù–û–í–õ–ï–ù–ò–• –ü–†–û–ì–†–ê–ú
# =========================

def get_windows_apps() -> List[str]:
    command = [
        "powershell", "-Command",
        "Get-ItemProperty HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*, "
        "HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | "
        "Select-Object DisplayName | Where-Object { $_.DisplayName } | "
        "ForEach-Object { $_.DisplayName }"
    ]

    result = subprocess.run(
        command,
        capture_output=True,
        text=True,
        encoding="utf-8",
        errors="ignore"
    )

    if result.returncode != 0:
        raise RuntimeError("–ü–æ–º–∏–ª–∫–∞ PowerShell")

    return sorted(set(
        line.strip() for line in result.stdout.split("\n") if line.strip()
    ))


def get_macos_apps() -> List[str]:
    command = "find /Applications -maxdepth 2 -name '*.app' -type d 2>/dev/null"
    result = subprocess.run(command, shell=True, capture_output=True, text=True)

    apps = []
    for path in result.stdout.split("\n"):
        if path:
            apps.append(path.split("/")[-1].replace(".app", ""))

    return sorted(set(apps))


def get_linux_apps() -> List[str]:
    try:
        result = subprocess.run(
            ["dpkg-query", "-W", "-f=${Package}\n"],
            capture_output=True,
            text=True,
            check=True
        )
        return sorted(set(result.stdout.split()))
    except Exception:
        result = subprocess.run(
            ["rpm", "-qa", "--qf", "%{NAME}\n"],
            capture_output=True,
            text=True
        )
        return sorted(set(result.stdout.split()))


def get_installed_apps() -> List[str]:
    system = platform.system()

    if system == "Windows":
        return get_windows_apps()
    elif system == "Darwin":
        return get_macos_apps()
    elif system == "Linux":
        return get_linux_apps()
    else:
        raise OSError("–ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∞ –û–°")


# =========================
# NVD API
# =========================

def search_vulnerabilities(keyword: str, limit: int = 10) -> Dict:
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    params = {
        "keywordSearch": keyword,
        "resultsPerPage": limit
    }

    headers = {
        "User-Agent": "SecurityScanner/1.0"
    }

    response = requests.get(url, params=params, headers=headers, timeout=30)
    response.raise_for_status()
    return response.json()


# =========================
# CVSS + SEVERITY
# =========================

def extract_cvss(metrics: dict) -> Optional[float]:
    """
    –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:
    1) CVSS v3.1
    2) CVSS v3.0
    3) CVSS v2
    """
    for key in ("cvssMetricV31", "cvssMetricV30", "cvssMetricV2"):
        metric = metrics.get(key)
        if metric:
            return metric[0]["cvssData"]["baseScore"]
    return None


def severity_from_score(score: float) -> str:
    if score >= 9.0:
        return "CRITICAL"
    elif score >= 7.0:
        return "HIGH"
    elif score >= 4.0:
        return "MEDIUM"
    return "LOW"


# =========================
# MAIN
# =========================

def main():
    apps = get_installed_apps()

    # –í–ò–ü–ê–î–ö–û–í–û –±–µ—Ä–µ–º–æ 5 –ø—Ä–æ–≥—Ä–∞–º
    sample_apps = random.sample(apps, min(5, len(apps)))

    results = []
    stats = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}

    for app in sample_apps:
        print(f"\nüîç –ê–Ω–∞–ª—ñ–∑: {app}")

        try:
            data = search_vulnerabilities(app)
            vulnerabilities = data.get("vulnerabilities", [])

            for item in vulnerabilities:
                cve = item.get("cve", {})
                metrics = cve.get("metrics", {})

                score = extract_cvss(metrics)
                if score is None or score < 8.0:
                    continue

                severity = severity_from_score(score)
                stats[severity] += 1

                description = cve.get("descriptions", [{}])[0].get("value", "N/A")

                results.append({
                    "App": app,
                    "CVE": cve.get("id", "N/A"),
                    "Score": score,
                    "Severity": severity,
                    "Description": description
                })

                print(f"  {cve.get('id')} | {score} | {severity}")

        except requests.exceptions.HTTPError as e:
            print(f"HTTP –ø–æ–º–∏–ª–∫–∞: {e}")
        except requests.exceptions.Timeout:
            print("Timeout –ø—Ä–∏ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –¥–æ NVD")
        except requests.exceptions.RequestException as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: {e}")

        time.sleep(6)  # rate-limit NVD

    # =========================
    # CSV (–û–î–ò–ù –†–ê–ó)
    # =========================

    with open("target_CVE.csv", "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(
            f,
            fieldnames=["App", "CVE", "Score", "Severity", "Description"]
        )
        writer.writeheader()
        writer.writerows(results)

    # =========================
    # –§–Ü–ù–ê–õ–¨–ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê
    # =========================

    print("\nüìä –ü–Ü–î–°–£–ú–ö–û–í–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    for level, count in stats.items():
        print(f"{level}: {count}")


if __name__ == "__main__":
    main()
